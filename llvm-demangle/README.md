copied from llvm master commit 77c5e43bd2babdfeaf60abc7dd37b3587a147c42